name: E2E
on:
  push:
    branches: [main]
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      BASE_URL: ${{ secrets.BASE_URL }}
      NEXT_PUBLIC_BASE_URL: ${{ secrets.BASE_URL }}
      CRON_SECRET: ${{ secrets.CRON_SECRET }}

    permissions:
      contents: read

    steps:
      - uses: actions/checkout@9bb56186c1a4490d6d6cf4b90efb4b0b10fc25d3

      - uses: actions/setup-node@60edca14a8b19c4ea3fd7a5c975299a9835c5caa
        with:
          node-version-file: '.nvmrc'
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Enable Corepack
        run: corepack enable

      - name: Activate pnpm
        run: |
          PNPM_VERSION=$(node -p "require('./package.json').packageManager.split('@')[1]")
          corepack prepare "pnpm@${PNPM_VERSION}" --activate

      - name: Show tool versions
        run: |
          node -v
          pnpm --version

      - name: Configure pnpm store dir for stable caching
        run: pnpm config set store-dir ~/.pnpm-store

      - name: Assert pnpm version
        run: node .github/scripts/assert-pnpm-version.mjs

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # âœ… Install Playwright browsers and required OS deps directly
      - name: Install Playwright browsers & OS deps
        run: pnpm exec playwright install --with-deps

      - name: Build app (prod)
        env:
          CI: "true"
          NEXT_TELEMETRY_DISABLED: "1"
        run: pnpm build

      - name: Run E2E tests
        env:
          # --- Minimal, safe test env ---
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: '1'
          E2E: 'true'
          TEST_MODE: 'true'
          ADMIN_AUTH_DISABLED: '1'     # make sure your server respects this
          ADMIN_BYPASS: 'true'
          NEXT_PUBLIC_REQUIRE_ADMIN_EMAIL_VERIFICATION: 'false'
          # Provide a stub service account to satisfy init code paths
          FIREBASE_SERVICE_ACCOUNT_JSON: |
            {
              "type": "service_account",
              "project_id": "test-project",
              "private_key_id": "test-key-id",
              "private_key": "-----BEGIN PRIVATE KEY-----\nMIIB...test\n-----END PRIVATE KEY-----\n",
              "client_email": "test@example.iam.gserviceaccount.com",
              "client_id": "1234567890",
              "auth_uri": "https://accounts.google.com/o/oauth2/auth",
              "token_uri": "https://oauth2.googleapis.com/token",
              "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
              "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/test"
            }
        run: pnpm e2e
        