name: Lockfile Check
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  lockfile:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      CI: true
      # we want env validation to run, but only with the minimal/bypass set
      SKIP_STRICT_ENV: 1

    steps:
      - uses: actions/checkout@v4
        # v4.2.2: https://github.com/actions/checkout/releases/tag/v4.2.2

      # make sure the pnpm store exists before we try to cache it
      - name: Create pnpm store dir
        run: mkdir -p ~/.pnpm-store

      # 1) standardize Node (as per audit) and enable pnpm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.18.1"
          cache: "pnpm"
          cache-dependency-path: pnpm-lock.yaml

      # 2) install pnpm in the supported way (no corepack signatures)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.6.2
          run_install: false

      # 3) show tool versions (helps debug runners)
      - name: Show tool versions
        run: |
          node -v
          pnpm -v

      # 4) make pnpm use the store we created, so the cache step is stable
      - name: Configure pnpm store dir for stable caching
        run: pnpm config set store-dir ~/.pnpm-store

      # 5) cache the pnpm store
      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      # 6) install dependencies, but ignore scripts so env validation in scripts can't fail this job
      - name: Install dependencies
        run: pnpm install --frozen-lockfile --ignore-scripts

      # 7) optional but useful: run the validator in bypass mode (SKIP_STRICT_ENV=1)
      #    this matches the audit: only the 6 public Firebase vars are enforced here
      - name: Validate environment (bypass allowed)
        run: pnpm env:check || true

      # 8) fail if pnpm-lock.yaml would change
      - name: Check lockfile is clean
        run: |
          if [ -n "$(git status --porcelain pnpm-lock.yaml)" ]; then
            echo "pnpm-lock.yaml is not up to date. Run 'pnpm install' locally and commit the changes."
            git diff pnpm-lock.yaml || true
            exit 1
          fi
