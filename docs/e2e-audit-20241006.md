# End-to-end Audit – 2024-10-06

The Playwright suite currently fails in 13 places. Below are the root causes and recommended fixes that preserve the existing UI while addressing the regressions.

## 1. Blog fallback heading mismatch
- **Failure**: `tests/admin-dashboard-blog-fallback.spec.ts` expects an `h1` named “Blog Posts,” but the loading and loaded states render “Blog Management.”【F:tests/admin-dashboard-blog-fallback.spec.ts†L3-L45】【F:app/admin/dashboard/components/blog-manager.tsx†L496-L607】
- **Fix**: Either change the `AdminPageHeader` title back to “Blog Posts” (preferred for consistency with navigation copy) or add a visually hidden alias (e.g., `aria-label="Blog Posts"`) so both skeleton and hydrated views expose the expected accessible name.

## 2. Sidebar overlay blocks hit testing on mobile
- **Failure**: `tests/admin-sidebar-overlay.spec.ts` probes the midpoint of `#app-sidebar`, but the Radix `SheetOverlay` (`pointer-events-auto`) and the sidebar’s own stacking context (`z-[60]`) allow the translucent scrim to intercept `elementFromPoint`, yielding `null`/overlay ids.【F:tests/admin-sidebar-overlay.spec.ts†L5-L29】【F:components/ui/sheet.tsx†L18-L80】【F:app/admin/dashboard/components/admin-sidebar.tsx†L118-L160】
- **Fix**: Give the overlay `pointer-events-none` (while keeping opacity) or move it behind the drawer, and ensure the sheet content’s z-index exceeds the overlay so `elementFromPoint` returns the sidebar element in strict mode.

## 3. Dashboard error landmark assertion fails
- **Failure**: The network-error scenario confirms the sidebar is visible, but `document.elementFromPoint` still returns `null` due to the same overlay stacking; once the overlay is passive, this test will also pass. No additional UI change required beyond the overlay fix.【F:tests/admin-dashboard-error.spec.ts†L15-L47】【F:components/ui/sheet.tsx†L18-L80】

## 4. Missing top-level heading trips Axe
- **Failure**: While the dashboard shell is mounting, `AdminLayout` returns a spinner without any heading, so Axe reports `page-has-heading-one` when tests close and reopen the drawer.【F:tests/mobile-nav.spec.ts†L6-L27】【F:app/admin/dashboard/components/admin-layout.tsx†L69-L118】
- **Fix**: Wrap the loading state with an `h1` (e.g., “Loading Admin Dashboard”) or reuse `AdminPageHeader` so every render path exposes a level-one heading.

## 5. Quick actions collide with live-region copy
- **Failure**: The quick actions test queries `page.getByText(expected)`, but the sr-only announcer also outputs “Section: Blog Management,” causing a strict-mode conflict.【F:tests/admin-quick-actions.spec.ts†L60-L83】【F:app/admin/dashboard/AdminDashboardPageClient.tsx†L480-L511】
- **Fix**: Give the announcer distinct text (e.g., prepend “Now viewing section: …”) or add a `data-testid`/`aria-label` so the visible heading remains the only exact match for the raw section title.

## 6. Blog dashboard copy drift
- **Failure**: Other dashboard tabs (e.g., navigation chips) still label the section “Blog Posts,” so align the `NAV` metadata with whichever label the UI should standardize on to avoid future mismatch between copy and tests.【F:app/admin/dashboard/AdminDashboardPageClient.tsx†L40-L118】
- **Fix**: Update the `NAV` map (and any badges) to use a single canonical string—either revert to “Blog Posts” everywhere or expose both via `sr-only` text so tests keep working without renaming visible UI.

## 7. Verify-email CTA detaches during click
- **Failure**: When `TEST_MODE` is true, clicking “I have verified” schedules an immediate redirect and sets the localStorage flag asynchronously. Playwright begins the click, the button disappears, and the action retries until timeout.【F:tests/admin-signup-flow.spec.ts†L36-L45】【F:app/admin/verify-email/VerifyEmailClient.tsx†L71-L252】
- **Fix**: Delay the redirect until after the button handler finishes (e.g., await a microtask before calling `startRedirect`) or perform the redirect inside a `setTimeout` so the element stays mounted long enough for the click to resolve.

## 8. Login error alert never surfaces
- **Failure**: The legacy `EmailLoginForm` clears `formError` and `error` at submit time, but in fast-fail scenarios the `setError("")` call runs after the network promise resolves, wiping the alert before the assertion executes.【F:tests/login.spec.ts†L5-L33】【F:app/admin/login/EmailLoginForm.tsx†L52-L133】
- **Fix**: Remove the unconditional `setError("")`/`setFormError(null)` combo or guard it (e.g., only clear after a successful response). Keeping the alert node mounted until the next attempt will satisfy the aria-live expectation.

## 9. MFA submission button label mismatch
- **Failure**: The MFA test clicks a button named “Login,” but both the legacy and Firebase forms render “Sign in,” so the handler never fires and the awaited `/api/admin/email-session` response never arrives.【F:tests/login.spec.ts†L71-L113】【F:app/admin/login/EmailLoginForm.tsx†L115-L137】【F:app/admin/login/FirebaseEmailLoginForm.tsx†L200-L210】
- **Fix**: Normalize the submit button’s accessible name—either change the text to “Login” or add `aria-label="Login"` so Playwright can trigger the request without altering visible copy.

## 10. Visual baselines are empty
- **Failure**: The three snapshot files under `tests/admin-login-legal-visual.spec.ts-snapshots/` are 0 bytes, so Playwright cannot decode them during comparisons.【F:tests/admin-login-legal-visual.spec.ts†L1-L27】【219447†L1-L5】
- **Fix**: Re-capture the baselines from a green run (`pnpm exec playwright test tests/admin-login-legal-visual.spec.ts --update-snapshots`) and commit the regenerated PNGs.

## 11. Skip link never gains focus
- **Failure**: The skip link only focuses itself when `document.activeElement === document.body`; in Next.js App Router, the body already contains a wrapper, so the first Tab doesn’t focus the link.【F:tests/skip-link.spec.tsx†L6-L18】【F:components/skip-link.tsx†L5-L41】
- **Fix**: Remove the active-element guard (or extend it to allow the first focusable wrapper) so the handler always forwards the first Tab to the skip link.

## 12. Media dashboard lacks a heading for empty states
- **Failure**: When `/api/media/list` returns zero items, the page never renders an `h1`/dialog named “Media,” so the locator in `tests/media.spec.ts` times out.【F:tests/media.spec.ts†L3-L23】【F:app/admin/dashboard/components/media/MediaLibrary.tsx†L507-L580】
- **Fix**: Introduce an `AdminPageHeader as="h1" title="Media"` (or expose a hidden heading within `renderEmptyState`) that remains mounted even before data arrives.

## 13. Axe scan on home page
- **Failure**: The global skip link visibility bug also prevents Axe from finding a level-one heading before interaction, contributing to the earlier violation; once the skip link fix (and loading-state heading) land, rerun the suite to confirm the accessibility scans are clean.【F:tests/mobile-nav.spec.ts†L6-L27】【F:components/skip-link.tsx†L5-L41】【F:app/admin/dashboard/components/admin-layout.tsx†L69-L118】

## Next steps
1. Implement the targeted fixes above, preferring accessible-name adjustments over visual changes where possible.
2. Re-run `pnpm test` and `pnpm e2e` (or the specific Playwright files) to ensure the 13 failing specs now pass.
3. Re-generate the admin login legal snapshots after confirming the layout is unchanged.

This plan keeps the existing admin UX intact while aligning the DOM and accessibility affordances with the test suite’s expectations.