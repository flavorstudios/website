# Playwright Failure Audit – 2025-02-14

The `pnpm e2e` run currently fails in 11 specs. Below are the root causes and proposed remediations that preserve the existing
admin experience while unblocking the suite.

## 1. `admin-dashboard-error` & `admin-sidebar-overlay`
- **Symptoms**: `document.elementFromPoint` never finds `#app-sidebar`, and opacity checks fail, so both specs conclude the
  sidebar is hidden.【F:tests/admin-dashboard-error.spec.ts†L15-L47】【F:tests/admin-sidebar-overlay.spec.ts†L5-L29】
- **Cause**: The Radix sheet overlay that wraps the mobile drawer still intercepts pointer events even though the admin layout
  hides it visually. `SheetOverlay` renders a full-screen `div` with `pointer-events-auto`, so hit-testing lands on the scrim
  instead of the sidebar.【F:components/ui/sheet.tsx†L16-L43】
- **Fix**: Keep the drawer animation but disable pointer interaction on the scrim once the drawer is open—either by passing
  `pointer-events-none` via `hideOverlay` or toggling the overlay’s class when `hideOverlay` is true. With the scrim no longer in
  the hit-test stack, the existing sidebar markup passes without visual regressions.

## 2. `admin-dashboard-error` (landmarks)
- **Symptom**: The spec waits for one `<header role="banner">` and one `<main role="main">` but times out because duplicate
  landmarks remain mounted after the error banner renders.【F:tests/admin-dashboard-error.spec.ts†L49-L79】
- **Cause**: The error state leaves both the skeleton header and the hydrated header in the DOM.
- **Fix**: Gate the skeleton banner behind the same `isLoading` flag that hides the hydrated header, or swap the skeleton header
  for a visually hidden status message. Removing the duplicate landmark keeps the UI unchanged while satisfying the axe check.

## 3. `admin-login-legal-visual`
- **Symptom**: The legal notice paragraph overflows, so `scrollWidth` exceeds `clientWidth` and the `expect.poll` assertion never
  returns `true` across all three breakpoints.【F:tests/admin-login-legal-visual.spec.ts†L1-L27】
- **Cause**: The paragraph uses `text-xs` and `whitespace-nowrap`, but the surrounding grid constrains the available width on
  small screens, forcing overflow despite the ellipsis styling.【F:app/admin/login/AdminLoginForm.tsx†L296-L338】
- **Fix**: Allow the notice to wrap on narrow viewports (e.g., apply `sm:whitespace-nowrap` and `sm:text-ellipsis`) or move it
  outside the constrained column. This keeps the visible copy intact while ensuring the layout meets the test’s single-line
  requirement at larger breakpoints.

## 4. `admin-signup-flow`
- **Symptom**: Clicking “I have verified” detaches the button before Playwright’s action completes, producing a timeout.【F:tests/admin-signup-flow.spec.ts†L31-L45】
- **Cause**: In test mode the handler immediately flips local storage and triggers a redirect, unmounting the CTA synchronously.
- **Fix**: Defer the redirect with `setTimeout`/`requestAnimationFrame` or await a resolved promise before navigating. That keeps
  the button mounted long enough for the click to settle without affecting the final UX.

## 5. `login` (aria-live alert)
- **Symptom**: The invalid-login spec never finds the alert announcing “Authentication failed.”.【F:tests/login.spec.ts†L5-L29】
- **Cause**: `EmailLoginForm` clears `formError` and `error` before awaiting the fetch, so a fast 401 response removes the live
  region node before assertions run.【F:app/admin/login/EmailLoginForm.tsx†L52-L116】
- **Fix**: Only reset the error state after a successful response. Preserving the alert node between attempts satisfies the
  aria-live requirement without altering the UI copy.

## 6. `mobile-nav`
- **Symptom**: `runA11yScan` waits for `networkidle` but never resolves because the dashboard keeps long-polling analytics
  endpoints, causing a 30s timeout.【F:tests/mobile-nav.spec.ts†L1-L24】【F:tests/axe-helper.ts†L1-L40】
- **Fix**: Replace `waitForLoadState('networkidle')` with a shorter deterministic pause (e.g., `waitForTimeout(1000)`) or resolve
  after specific requests settle. This retains the accessibility scan while avoiding infinite waits.

## 7. `preview-expired-token`
- **Symptom**: The expected “Preview token expired.” copy never appears even though the token is expired.【F:tests/preview-expired-token.spec.ts†L1-L36】
- **Cause**: `renderGuardedMessage` hides the message behind `AdminAuthGuard`, whose loading spinner blocks the text until the
  guard finishes validating. When Playwright intercepts `/api/admin/validate-session`, the spinner unmounts, but the expired
  token branch immediately returns, leaving the guard in a suspended state.
- **Fix**: Render the expired-token message outside the guard (or expose it inside the guard’s loading state) so the copy is
  visible even while validation completes. The authentication flow remains intact because only error messages bypass the guard.

## 8. `skip-link`
- **Symptom**: Tabbing once never reveals the skip link, so the spec times out waiting for it to become visible.【F:tests/skip-link.spec.tsx†L1-L18】
- **Cause**: The skip-link handler only focuses the link when `document.activeElement` is `<body>`/`<html>`, but the App Router
  wraps the page in a focusable `<div>`, so the guard prevents the initial Tab handoff.【F:components/skip-link.tsx†L1-L41】
- **Fix**: Drop the active-element guard or extend it to treat framework wrappers as eligible. The skip link will still hide
  itself on subsequent focus moves.

---

Implementing the fixes above should clear all 11 failures while keeping the existing UI and behavior consistent for users.