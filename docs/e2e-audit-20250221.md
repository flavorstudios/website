# Playwright E2E Failure Audit (February 2025)

## Summary
- 10 Playwright specs failed under `pnpm e2e`; most regressions stem from accessibility heading duplication, outdated UI expectations in the tests, or missing visual baselines.
- The admin email login flow renders the legacy form in test mode, so assertions that look for a "Sign in" button fail because the rendered button is labelled "Login".
- Several navigation assertions are still looking for historic copy such as "Blog Management", while the UI has been renamed to "Blog Posts".
- The skip-link visibility check is running before any focus change, but duplicated CSS definitions may be keeping the link visible on load.

## Detailed findings and recommendations

### 1. `admin-dashboard-blog-fallback` strict mode violation
- **What failed**: `page.getByRole('heading', { name: 'Blog Posts' })` resolves to two elements, causing a strict mode failure.
- **Root cause**: The dashboard template renders a screen-reader-only `<h1>` plus a visible `<h1>` supplied by `AdminPageHeader`, so the same accessible name exists twice.【F:app/admin/dashboard/AdminDashboardPageClient.tsx†L440-L519】【F:components/AdminPageHeader.tsx†L14-L27】
- **Recommendation**: Pick a single semantic heading. Either drop the SR-only `<h1>` in favour of referencing the visible heading (e.g. via `aria-labelledby`), or keep the SR-only element but give the visible heading `aria-hidden="true"`/`role="presentation"`. Updating the Playwright locator to target `data-testid="dashboard-page-heading"` would also avoid the strict locator failure once the accessible structure is clarified.

### 2. `admin-login-legal-visual` missing snapshots
- **What failed**: All three viewport variants wrote `*-actual.png` files because no baselines exist at `tests/admin-login-legal-visual.spec.ts-snapshots/`.
- **Root cause**: The project never committed initial snapshots for this spec; the test harness expects `admin-login-legal-<viewport>-linux.png` files.【F:tests/admin-login-legal-visual.spec.ts†L10-L24】
- **Recommendation**: Generate the baselines locally with `pnpm visual:update` (defined in `package.json`) and commit the resulting PNGs so Playwright can diff against them in CI.【F:package.json†L15-L26】

### 3. Email login button label mismatch breaks onboarding and login specs
- **What failed**: `admin-onboarding` and `login.spec.ts` wait for a button named "Sign in", then time out.
- **Root cause**: In test mode the legacy `EmailLoginForm` renders (because `TEST_MODE` is true), and its submit button is labelled "Login" rather than "Sign in". The specs target `/^sign in$/i`, so no matching element ever appears.【F:app/admin/login/EmailLoginForm.tsx†L221-L231】【F:tests/admin-onboarding.spec.ts†L70-L88】【F:tests/login.spec.ts†L18-L27】 By contrast, the Firebase form (hidden in test mode) still uses "Sign in".【F:app/admin/login/FirebaseEmailLoginForm.tsx†L206-L209】
- **Recommendation**: Align the button copy between the legacy and Firebase forms (e.g. use "Sign in" everywhere) or relax the Playwright selector to accept both "Login" and "Sign in". Once the labels agree, the click-and-redirect assertions will resume working.

### 4. Quick action and tab assertions use outdated copy
- **What failed**: `admin-quick-actions` and `admin-tabs` expect headings like "Blog Management" that no longer exist after the dashboard rename.
- **Root cause**: The blog section header now renders "Blog Posts" via `AdminPageHeader`, but the specs still look for the retired copy.【F:app/admin/dashboard/components/blog-manager.tsx†L576-L607】【F:tests/admin-quick-actions.spec.ts†L24-L41】【F:tests/admin-tabs.spec.ts†L63-L83】
- **Recommendation**: Update the assertions to match the current headings (e.g. expect `/Blog Posts/i`), or reintroduce the legacy copy in the UI if that wording is still desired. Synchronising the tests with the live content is the simplest fix.

### 5. Mobile sidebar overlay check returns `null`
- **What failed**: `admin-sidebar-overlay` probes `document.elementFromPoint` and expects to hit `#app-sidebar`, but receives `null` instead.
- **Root cause**: The sidebar adds `pointer-events: none` when closed and the overlay pseudo-element (`.admin-shell--with-overlay::after`) establishes a new stacking context while the drawer animates.【F:app/admin/dashboard/components/admin-sidebar.tsx†L68-L123】【F:styles/globals.css†L199-L223】 Depending on animation timing, the probe can land while the sidebar is still inert or overlapped.
- **Recommendation**: After toggling, wait for the drawer transition to finish (e.g. `await sidebar.waitForElementState('stable')`) before sampling `elementFromPoint`, or expose a data attribute that confirms the drawer is fully open. Alternatively, move the overlay pseudo-element outside the sidebar column or drop `pointer-events: none` once `sidebarOpen` is true.

### 6. Skip link considered visible on load
- **What failed**: `skip-link.spec.tsx` asserts the skip link is hidden pre-focus, but `toBeVisible()` passes because the element is rendered at full opacity.
- **Root cause**: The app ships two conflicting `.skip-link` definitions (`app/globals.css` and `styles/globals.css`). The App Router stylesheet sets `opacity: 0` only via `:not(:focus):not(:focus-visible)`, so before hydration Playwright sees the base styles (no clip/opacity) and treats the link as visible.【F:components/skip-link.tsx†L5-L31】【F:app/globals.css†L101-L134】【F:styles/globals.css†L312-L339】
- **Recommendation**: Consolidate to a single skip-link stylesheet and ensure the default rule hides the link even before focus (e.g. add `opacity: 0` / `clip-path` on the base class). Alternatively, toggle a `data-visible` attribute from the component and assert against that state in the test.

### 7. Preview route 410 noise (non-blocking)
- **Observation**: The Playwright run logged multiple 410 responses from `/admin/preview/[id]` due to expired preview tokens.
- **Impact**: These errors did not fail tests but add noise to CI logs. They happen when components prefetch preview data without supplying the signed token.
- **Recommendation**: Stub the preview stream in relevant specs (route `**/admin/preview/**` to return 200) or guard the client code to skip preview fetches during test mode.

## Next steps
1. Decide whether to harmonise the admin headings/UI copy or relax the Playwright assertions, then update the affected specs accordingly.
2. Regenerate and commit the admin login legal footer snapshots using `pnpm visual:update`.
3. Harmonise the legacy and Firebase login button labels (or broaden the test matcher) so onboarding and login specs can locate the submit control.
4. Revisit the skip-link styles to guarantee the link is hidden before focus, removing duplicated definitions to avoid inconsistent computed styles.
5. Add a short wait or state assertion in the sidebar overlay test—or adjust the overlay styling—so `elementFromPoint` reliably resolves to `#app-sidebar`.
6. Stub preview/tokened routes during tests to eliminate noisy 410 logs.
