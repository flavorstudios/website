# Playwright E2E Failure Audit (March 2025)

## Overview
The `pnpm e2e` run completed with 11 failing specs (26 passing). Each failure maps to either accessibility regressions, stale Playwright expectations, or missing test fixtures. The sections below capture the probable root cause and recommended remediation steps while keeping the existing implementation intact.

## Findings & Recommendations

### 1. Duplicate `h1` accessible names on the blog dashboard
- **Symptom**: `admin-dashboard-blog-fallback.spec.ts` fails because `getByRole('heading', { name: 'Blog Posts' })` matches two elements.
- **Root cause**: The dashboard renders a screen-reader-only `<h1 data-testid="dashboard-page-heading">` and the `AdminPageHeader` injects a visible `<h1>` with the same accessible name, triggering Playwright strict-mode violations.【F:app/admin/dashboard/AdminDashboardPageClient.tsx†L440-L519】【F:components/AdminPageHeader.tsx†L14-L27】
- **Recommendation**:
  - Pick a single semantic heading: either hide the visible `<h1>` from assistive tech (`aria-hidden="true"`) or demote it to a presentation tag.
  - Alternatively, adjust the test to target `data-testid="dashboard-page-heading"` once the accessibility structure is finalised.

### 2. Admin dashboard error overlay probe returns `null`
- **Symptom**: `admin-dashboard-error.spec.ts` expects `elementFromPoint` to resolve within `#app-sidebar` but receives `null`.
- **Root cause**: The mobile sidebar disables pointer events while animating open (`pointer-events-none`) and the overlay pseudo-element (`.admin-shell--with-overlay::after`) can temporarily sit above the sidebar, so the probe misses the element.【F:app/admin/dashboard/components/admin-sidebar.tsx†L118-L160】【F:styles/globals.css†L199-L223】
- **Recommendation**:
  - Wait for the sidebar to finish animating (`await sidebar.waitForElementState('stable')`) before probing.
  - Or expose a `data-sidebar-state="open"` attribute that the test can assert instead of relying on `elementFromPoint`.

### 3. Missing visual regression baselines
- **Symptom**: `admin-login-legal-visual.spec.ts` fails for mobile, tablet, and desktop—Playwright writes `*-actual.png` files because no snapshots exist.
- **Root cause**: The snapshot directory `tests/admin-login-legal-visual.spec.ts-snapshots/` lacks committed baselines.【F:tests/admin-login-legal-visual.spec.ts†L10-L24】
- **Recommendation**: Generate and commit the baselines via `pnpm visual:update` (defined in `package.json`) and re-run the suite.【F:package.json†L15-L26】

### 4. Email login button label mismatch
- **Symptom**: `admin-onboarding.spec.ts` and `login.spec.ts` time out waiting for a button named "Sign in".
- **Root cause**: With `TEST_MODE` enabled the legacy `EmailLoginForm` renders and its submit button text is "Login"/"Logging in…", while the tests (and the Firebase form) expect "Sign in".【F:app/admin/login/EmailLoginForm.tsx†L221-L231】【F:tests/admin-onboarding.spec.ts†L70-L88】【F:tests/login.spec.ts†L18-L27】
- **Recommendation**: Align the button label across both forms (e.g., change legacy copy to "Sign in") or broaden the Playwright locator to accept both phrases.

### 5. Stale copy in quick actions and admin tabs tests
- **Symptom**: `admin-quick-actions.spec.ts` and `admin-tabs.spec.ts` look for headings such as "Blog Management" which no longer appear.
- **Root cause**: The dashboard header now renders "Blog Posts" and other updated strings via `AdminPageHeader`, so the tests point at legacy copy.【F:app/admin/dashboard/components/blog-manager.tsx†L576-L608】【F:tests/admin-quick-actions.spec.ts†L60-L83】【F:tests/admin-tabs.spec.ts†L60-L90】
- **Recommendation**: Refresh the expected strings in the tests to match current UI labels (e.g., expect `/Blog Posts/i`).

### 6. Skip link visibility assertion fails
- **Symptom**: `skip-link.spec.tsx` sees the skip link as visible before focus, violating the expectation that it starts hidden.
- **Root cause**: Two competing `.skip-link` style blocks exist (`app/globals.css` and `styles/globals.css`); depending on load order Playwright reads the base rule without the hiding clamp, so the link renders visible pre-focus.【F:components/skip-link.tsx†L1-L41】【F:app/globals.css†L100-L137】【F:styles/globals.css†L323-L353】
- **Recommendation**: Consolidate to a single skip-link stylesheet and ensure the base class hides the element (e.g., default `opacity: 0`/`clip`). As a non-breaking alternative, have the component toggle a `data-visible` attribute and let the test assert `toHaveAttribute`.

### 7. Miscellaneous preview 410 noise
- **Observation**: Requests to `/admin/preview/[id]` returned 410 during the run, cluttering logs.
- **Recommendation**: Route-match these endpoints in Playwright tests and fulfill with 200/empty body to keep logs clean during CI.

## Suggested Remediation Order
1. Commit the missing visual baselines so the suite can compare screenshots.
2. Harmonise the login button label and update selectors for renamed headings.
3. Resolve heading duplication and skip-link styling to satisfy accessibility checks.
4. Stabilise the sidebar overlay test by asserting deterministic state instead of pointer probes.
5. Add preview route stubs where needed.

Addressing the above should bring the Playwright suite back to green without undoing prior implementation work.