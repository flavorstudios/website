# E2E Failure Audit – Playwright run (pnpm e2e)

## Summary
- Admin dashboard expectations diverge from the rendered copy and structure, breaking card fallback, quick-action, and axe assertions.
- The mobile sidebar uses a global `Sheet` overlay that still intercepts pointer hit-tests after opening, so element probes miss the drawer.
- Visual regression snapshots for the admin login legal notice are zero-byte files, causing all screenshot comparisons to crash.
- The admin login workflows under test mix the legacy (env-backed) form and the Firebase form, leading to mismatched selectors and missing network intercepts.
- Media library and marketing skip-link flows both lack the accessibility hooks the tests assert against (no `h1 "Media"`, skip link never focuses), so the assertions time out.

## Findings & Recommendations

### 1. Blog dashboard copy drift
- The blog manager now renders its heading as `Blog Management`, but multiple tests still look for `"Blog Posts"`, causing strict role/label assertions to fail.【F:app/admin/dashboard/components/blog-manager.tsx†L576-L607】【F:tests/admin-dashboard-blog-fallback.spec.ts†L3-L45】【F:tests/admin-quick-actions.spec.ts†L60-L83】
- **Fix**: Align the expectations with the live copy. Either update the specs to match `Blog Management` (preferred), or add a secondary `<span>`/`aria-label` that retains `Blog Posts` for compatibility.

### 2. Mobile sidebar overlay hit-tests
- On mobile we mount the sidebar inside a shadcn `Sheet`, whose overlay renders as a full-viewport div with `pointer-events-auto`. `document.elementFromPoint` therefore grabs the overlay instead of the sidebar even after opening it.【F:components/ui/sheet.tsx†L24-L89】【F:tests/admin-sidebar-overlay.spec.ts†L5-L29】
- **Fix**: Pass `hideOverlay` to the `SheetContent` used by `AdminLayout`, or customize the sheet overlay to set `pointer-events-none` once the drawer is open. With the overlay out of the stacking context, `elementFromPoint` will resolve inside `#app-sidebar` and the opacity probe in `admin-dashboard-error.spec.ts` will succeed.【F:app/admin/dashboard/components/admin-layout.tsx†L52-L108】

### 3. Dashboard overview lacks a level-one heading
- The overview section renders only `h2` headings ("Welcome back"), so axe reports `page-has-heading-one` whenever the admin shell loads, tripping `mobile-nav.spec.ts`.【F:app/admin/dashboard/components/dashboard-overview.tsx†L340-L402】
- **Fix**: Promote the primary welcome text to an `h1` (or render an `AdminPageHeader` with `as="h1"`) so the page exposes a single level-one heading.

### 4. Admin login – visual snapshots & error handling
- All three stored snapshots for the legal footer are empty (0-byte) PNGs, so `toHaveScreenshot` throws "could not decode image as PNG" immediately.【ccbc7c†L1-L8】
  - **Fix**: Re-record the baselines (`pnpm playwright test tests/admin-login-legal-visual.spec.ts --update-snapshots`) and commit the regenerated PNGs.
- The legacy email form does surface the alert text `Authentication failed.` inside an aria-live region, but tests may hit the Firebase variant instead by toggling the "Use modern admin login" button, leaving no `role="alert"` node for their locator.【F:app/admin/login/AdminLoginForm.tsx†L232-L274】【F:app/admin/login/EmailLoginForm.tsx†L86-L146】
  - **Fix**: Stabilize the test-mode toggle—e.g., gate the Firebase variant behind an explicit test flag or expose a deterministic `data-testid` the suite can assert before interacting. Once the legacy form is guaranteed active, the existing selectors (`getByRole('alert', { name: 'Authentication failed.' })`) will resolve.
- The MFA flow waits for a `POST /api/admin/email-session`, but the Firebase form posts to `/api/admin/email-login`. When the toggle flips, no matching network request occurs and the test times out.【F:tests/login.spec.ts†L55-L112】【F:app/admin/login/FirebaseEmailLoginForm.tsx†L67-L131】
  - **Fix**: Ensure the legacy form handles MFA in test mode (keep the toggle off) or update the test to expect `/api/admin/email-login`. Clarifying which form is under automation will resolve both login failures.

### 5. Media library lacks an accessible landmark
- The media dashboard renders its title as an `h2` (`Media Library`) within the toolbar. The test looks for a dialog, details drawer, or `main h1` containing "Media" and times out when none exist.【F:app/admin/dashboard/components/media/MediaToolbar.tsx†L66-L108】【F:tests/media.spec.ts†L1-L27】
- **Fix**: Add an `AdminPageHeader` with `as="h1"` (or promote the existing title) so the primary view exposes an `h1` for the locator to match. Alternatively, adjust the test to target `[data-testid="media-toolbar"]` once provided.

### 6. Skip link never becomes focus-visible
- The skip link relies on a global keydown handler that only focuses the anchor when `document.activeElement === document.body`. During Playwright navigation the focus often lands on `html` or the Next.js app wrapper, so pressing `Tab` never shifts focus and the element stays hidden.【F:components/skip-link.tsx†L5-L31】【F:tests/skip-link.spec.tsx†L1-L24】
- **Fix**: Let the skip link remain first in the DOM and remove the manual keydown hack, or broaden the focus guard (e.g., treat `document.activeElement` of `null`, `body`, or `html` as eligible). With predictable focus management, the visibility assertion will pass.

### 7. Miscellaneous warnings
- Lint flagged the unused `Placeholder` import inside the rich text editor (`app/admin/dashboard/components/rich-text-editor.tsx` line 31). Removing it will keep `pnpm e2e` output clean.【F:app/admin/dashboard/components/rich-text-editor.tsx†L1-L40】

## Next Steps
1. Update the affected Playwright specs (or UI copy) to reflect the current admin wording and heading hierarchy.
2. Tweak the mobile sidebar sheet configuration so overlays stop intercepting pointer checks.
3. Restore valid admin login snapshots and lock the tests to the intended login variant.
4. Add or promote `h1` headings for the admin overview and media pages to satisfy accessibility assertions.
5. Simplify the skip-link focus logic so keyboard navigation reliably exposes the control.