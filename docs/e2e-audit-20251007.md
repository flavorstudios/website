# E2E Failure Audit – 2025-10-07

## 1. Mobile drawer overlay blocks sidebar hit-testing
- **Failing specs**: `tests/admin-dashboard-error.spec.ts`, `tests/admin-sidebar-overlay.spec.ts`.
- **What happens**: the Radix sheet overlay used on mobile keeps `pointer-events: auto` while the drawer is open, so `document.elementFromPoint` resolves to the overlay instead of the sidebar. The sidebar itself also inherits a lower stacking context because the overlay sits above it.【F:components/ui/sheet.tsx†L18-L88】【F:app/admin/dashboard/components/admin-layout.tsx†L80-L117】
- **Suggested fix**: when the admin shell renders the sheet, pass `hideOverlay` so the `SheetContent` skips the overlay, or patch `SheetOverlay` to toggle `pointer-events-none`/`opacity-0` once the drawer opens. Either change keeps the existing drawer animation while allowing the Playwright opacity probe to reach `#app-sidebar`.

## 2. Dashboard fallback states miss a level-one heading
- **Failing spec**: `tests/mobile-nav.spec.ts` (Axe `page-has-heading-one`).
- **What happens**: every analytics failure branch only renders `<h2>` copy ("Dashboard data unavailable") or plain text, so the page lacks any `<h1>` whenever stats fail to load, exactly the state exercised in CI. Axe therefore flags the missing heading and the scan fails.【F:app/admin/dashboard/components/dashboard-overview.tsx†L311-L352】
- **Suggested fix**: reuse `AdminPageHeader` with `as="h1"` inside the fallback blocks (permission denied, network error, empty stats) or add a visually hidden `<h1>` that mirrors the regular heading. That single structural change will keep the semantic landmark present for Axe.

## 3. Blog tab heading mismatch
- **Failing spec**: `tests/admin-tabs.spec.ts` (`getByRole('heading', { name: /Blog Management/i })`).
- **What happens**: the UI now sets the `<h1>` to "Blog Posts" and moves "Blog Management" into a badge. Because the badge is not part of the heading’s accessible name, the locator never resolves and the test times out.【F:app/admin/dashboard/components/blog-manager.tsx†L585-L618】
- **Suggested fix**: either swap the `<AdminPageHeader>` title back to "Blog Management", or wrap the badge text in a visually hidden span inside the `<h1>` so that the accessible name still includes "Blog Management" while preserving the visible "Blog Posts" copy.

## 4. Admin login aria-live assertion
- **Failing spec**: `tests/login.spec.ts` (expects a single `role="alert"` node reading "Authentication failed.").
- **What happens**: when Playwright clicks "Sign in", the form routes through `EmailLoginForm`, which clears the error state before submitting and then populates it with the failure message after the mocked 401. Because the legacy form is only active when `clientEnv.TEST_MODE === 'true'`, any production-like build that resolves `TEST_MODE` to false swaps in the Firebase variant, and the locator no longer matches the legacy alert node.【F:app/admin/login/AdminLoginForm.tsx†L71-L143】【F:app/admin/login/EmailLoginForm.tsx†L80-L176】
- **Suggested fix**: force test mode explicitly (e.g., set `NEXT_PUBLIC_TEST_MODE=true` in the Playwright test environment or gate the Firebase form behind a dedicated `clientEnv.ENABLE_FIREBASE_LOGIN` flag). That keeps the legacy form active in CI, ensuring the alert remains deterministic.

## 5. Broken admin-login visual snapshots
- **Failing spec**: `tests/admin-login-legal-visual.spec.ts` (Playwright cannot decode the reference PNGs).
- **What happens**: the stored baselines for the legal notice are zero-byte files, so Playwright fails while trying to compare the current screenshot to an empty reference.【cb9d13†L1-L9】
- **Suggested fix**: regenerate the snapshots locally with `pnpm playwright test tests/admin-login-legal-visual.spec.ts --update-snapshots` and commit the non-empty PNGs.

## 6. Skip-link interaction + Axe run instability
- **Failing specs**: `tests/skip-link.spec.tsx` (visibility + Axe navigation crash).
- **What happens**: the custom skip-link component only focuses itself when the first Tab happens to originate from `<body>`, and the service-worker registration in `PwaServiceWorker` triggers a full-page reload (`controllerchange` → `window.location.reload()`) right after hydration. The reload clears focus before the expectation and disrupts Axe with a mid-scan navigation.【F:components/skip-link.tsx†L5-L48】【F:components/PwaServiceWorker.tsx†L9-L64】
- **Suggested fix**: simplify the skip link to rely on its natural DOM order (drop the keydown trap) and skip service-worker registration whenever `clientEnv.TEST_MODE === 'true'`. With no unexpected reloads, the skip link remains focused after the first Tab and Axe can finish its scan.

## 7. Lint warning from unused TipTap placeholder
- **Failing step**: Next.js lint/type check emits an `@typescript-eslint/no-unused-vars` warning during the pre-e2e build.
- **What happens**: the `Placeholder` extension import in `RichTextEditor` is unused, so linting surfaces it as a warning and breaks clean CI runs.【F:app/admin/dashboard/components/rich-text-editor.tsx†L11-L103】
- **Suggested fix**: remove the unused `Placeholder` import (and related configuration if it was previously used) to restore a warning-free build.